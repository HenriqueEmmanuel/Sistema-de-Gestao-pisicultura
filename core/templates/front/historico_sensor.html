{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tilapia Control - Histórico de Sensores</title>
  <link rel="stylesheet" href="{% static 'css/index.css' %}">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/png">

</head>

<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <h2>TilapiaControl</h2>
      <nav>
        <ul>
          <li><a href="#" data-url="{% url 'dashboard_content' %}"
              onclick="carregarConteudo(this.dataset.url); return false;"><i class="fas fa-home"></i> Dashboard</a></li>
          <li><a href="#" data-url="{% url 'tank' %}" onclick="carregarConteudo(this.dataset.url); return false;"><i
                class="fas fa-fish"></i> Gerenciar Tanques</a></li>
          <li><a href="#" data-url="{% url 'cadastro_tanque' %}"
              onclick="carregarConteudo(this.dataset.url); return false;"><i class="fas fa-plus-circle"></i> Novo
              Tanque</a></li>
          <li><a href="{% url 'analise' %}" onclick="event.preventDefault(); carregarConteudo(this.href)"><i
                class="fas fa-chart-line"></i><i class="fas fa-video"></i> Análise em Tempo Real</a></li>
          <li>
            <a href="{% url 'historico_sensor' %}">
              <i class="fas fa-history"></i> Histórico Sensores
            </a>
          </li>
          <li><a href="#" data-url="{% url 'histo_analise' %}"
              onclick="carregarConteudo(this.dataset.url); return false;"><i class="fas fa-history"></i> Histórico de
              Análises</a></li>
          <li><a href="#" data-url="{% url 'gerenciamento_sensor' %}"
              onclick="carregarConteudo(this.dataset.url); return false;"><i class="fas fa-sliders-h"></i> Gerenciar
              Sensores</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">

      {{ block.super }}

      <section class="filters">
        <div>
          <label for="tank">Tanque</label>
          <select id="tank">
          </select>
        </div>

        <div>
          <label for="parameter">Parâmetro</label>
          <select id="parameter">
            <option value="temperature">Temperatura (°C)</option>
            <option value="ph">pH</option>
            <option value="ammonia">Amônia (mg/L)</option>
            <option value="oxygen">Oxigênio (mg/L)</option>
            <option value="tds">Sólidos Dissolvidos (ppm)</option>
            <option value="nitrito">Nitrito (ppm)</option>
            <option value="nitrato">Nitrato (ppm)</option>
            <option value="salinidade">Salinidade (ppm)</option>
            <option value="dureza_geral">Dureza Geral (GH)</option>
            <option value="dureza_carbonatos">Dureza Carbonatos (KH)</option>
          </select>
        </div>

        <div>
          <label for="period">Período</label>
          <select id="period">
            <option value="7">Últimos 7 dias</option>
            <option value="15">Últimos 15 dias</option>
            <option value="30">Últimos 30 dias</option>
            <option value="90">Últimos 90 dias</option>
          </select>
        </div>

        <div>
          <button id="exportBtn"><i class="fas fa-download"></i> Exportar CSV</button>
        </div>
      </section>

      <div class="cards-container">
        <div class="card-box">
          <span class="green" id="minValue">0</span>
          <h3>Valor Mínimo</h3>
        </div>
        <div class="card-box">
          <span class="blue" id="avgValue">0</span>
          <h3>Valor Médio</h3>
        </div>
        <div class="card-box">
          <span class="red" id="maxValue">0</span>
          <h3>Valor Máximo</h3>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="chart" width="800" height="400"></canvas>
      </div>

      <section class="table-container">
        <h2>Dados Recentes</h2>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Valor</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="dataTableBody">
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>
  <script src="{% static 'js/dashboard.js' %}" defer></script>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function initHistoricoSensor() {
    const tankSelect = document.getElementById("tank");

    if (!tankSelect) {
      console.log("Select de tanques não encontrado.");
      return;
    }

    fetch("/api/tanques-do-usuario/")
      .then(res => res.json())
      .then(tanques => {
        tankSelect.innerHTML = "";
        tanques.forEach(tanque => {
          const option = document.createElement("option");
          option.value = tanque.id;
          option.textContent = tanque.nome;
          tankSelect.appendChild(option);
        });

        if (tanques.length > 0) {
          tankSelect.value = tanques[0].id;
        }

        console.log("Tanques carregados:", tanques);
      })
      .catch(e => console.error("Erro ao carregar tanques:", e));
  }




  const parameterSelect = document.getElementById('parameter');
  const periodSelect = document.getElementById('period');
  const tankSelect = document.getElementById('tank');
  const exportBtn = document.getElementById('exportBtn');
  const minValueEl = document.getElementById('minValue');
  const avgValueEl = document.getElementById('avgValue');
  const maxValueEl = document.getElementById('maxValue');
  const dataTableBody = document.getElementById('dataTableBody');
  const ctx = document.getElementById('chart').getContext('2d');

  let chartInstance = null;
  let chartData = [];

  const parameters = {
    temperature: { label: 'Temperatura', unit: '°C', color: '#ef4444' },
    ph: { label: 'pH', unit: '', color: '#3b82f6' },
    ammonia: { label: 'Amônia', unit: 'mg/L', color: '#eab308' },
    oxygen: { label: 'Oxigênio', unit: 'mg/L', color: '#22c55e' },
    tds: { label: 'Sólidos Dissolvidos', unit: 'ppm', color: '#8b5cf6' },
    nitrito: { label: 'Nitrito', unit: 'ppm', color: '#f59e0b' },
    nitrato: { label: 'Nitrato', unit: 'ppm', color: '#10b981' },
    salinidade: { label: 'Salinidade', unit: 'ppm', color: '#f472b6' },
    dureza_geral: { label: 'Dureza Geral (GH)', unit: '°dH', color: '#0ea5e9' },
    dureza_carbonatos: { label: 'Dureza Carbonatos (KH)', unit: '°dH', color: '#9333ea' }
  };

  function getStatus(parameter, value) {
    switch (parameter) {
      case 'temperature': return value < 24 || value > 28 ? { label: 'Atenção', className: 'status-warning' } : { label: 'Normal', className: 'status-normal' };
      case 'ph': return value < 7 || value > 8 ? { label: 'Atenção', className: 'status-warning' } : { label: 'Normal', className: 'status-normal' };
      case 'ammonia': return value > 0.3 ? { label: 'Crítico', className: 'status-critical' } : { label: 'Normal', className: 'status-normal' };
      case 'oxygen': return value < 5 ? { label: 'Atenção', className: 'status-warning' } : { label: 'Normal', className: 'status-normal' };
      case 'nitrito': return value > 0.2 ? { label: 'Crítico', className: 'status-critical' } : { label: 'Normal', className: 'status-normal' };
      case 'nitrato': return value > 40 ? { label: 'Atenção', className: 'status-warning' } : { label: 'Normal', className: 'status-normal' };
      case 'tds': case 'salinidade': return value > 500 ? { label: 'Atenção', className: 'status-warning' } : { label: 'Normal', className: 'status-normal' };
      case 'dureza_geral': return value < 4 ? { label: 'Atenção', className: 'status-warning' } : { label: 'Normal', className: 'status-normal' };
      case 'dureza_carbonatos': return value < 3 ? { label: 'Atenção', className: 'status-warning' } : { label: 'Normal', className: 'status-normal' };
      default: return { label: 'Normal', className: 'status-normal' };
    }
  }

  function getStatistics(data) {
    if (!data.length) return { min: 0, max: 0, avg: 0 };
    const values = data.map(d => d.value);
    const min = Math.min(...values);
    const max = Math.max(...values);
    const avg = values.reduce((a, b) => a + b, 0) / values.length;
    return { min, max, avg: avg.toFixed(2) };
  }

  function updateStats(stats, unit) {
    minValueEl.textContent = stats.min + unit;
    avgValueEl.textContent = stats.avg + unit;
    maxValueEl.textContent = stats.max + unit;
  }

  function updateTable(data, parametro) {
    dataTableBody.innerHTML = '';
    const recentData = data.slice(-20).reverse();
    recentData.forEach(item => {
      const status = getStatus(parametro, item.value);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.date}</td>
        <td>${item.value}${parameters[parametro].unit}</td>
        <td class="${status.className}">${status.label}</td>
      `;
      dataTableBody.appendChild(row);
    });
  }

  function updateChart(data, parametro) {
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => d.date),
        datasets: [{
          label: `${parameters[parametro].label} (${parameters[parametro].unit})`,
          data: data.map(d => d.value),
          borderColor: parameters[parametro].color,
          backgroundColor: parameters[parametro].color + '80',
          fill: false,
          tension: 0.3,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 15 } },
          y: { beginAtZero: false }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.parsed.y}${parameters[parametro].unit}`
            }
          }
        }
      }
    });
  }

  function exportCSV(data, parametro) {
    const header = ['Data', 'Parâmetro', 'Valor', 'Unidade'];
    const rows = data.map(d => [
      d.date,
      parameters[parametro].label,
      d.value,
      parameters[parametro].unit
    ]);
    const csvContent = [header, ...rows].map(e => e.join(',')).join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', `historico_${parametro}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  async function updateAll() {
    const parametro = parameterSelect.value;
    const dias = periodSelect.value;
    const tanqueId = tankSelect.value;

    if (!tanqueId) return;

    try {
      const res = await fetch(`/api/dados-sensores/?parametro=${parametro}&dias=${dias}&tanque_id=${tanqueId}`);
      const json = await res.json();

      if (json.error) {
        console.error(json.error);
        return;
      }

      chartData = json.dados;
      const stats = getStatistics(chartData);
      updateStats(stats, parameters[parametro].unit);
      updateTable(chartData, parametro);
      updateChart(chartData, parametro);
    } catch (e) {
      console.error("Erro ao buscar dados:", e);
    }
  }

  async function carregarTanques() {
    try {
      const response = await fetch("/api/tanques-do-usuario/");
      const tanques = await response.json();
      tankSelect.innerHTML = "";

      tanques.forEach((tanque, index) => {
        const option = document.createElement("option");
        option.value = tanque.id;
        option.textContent = tanque.nome;
        if (index === 0) option.selected = true;
        tankSelect.appendChild(option);
      });

      updateAll(); 
    } catch (error) {
      console.error("Erro ao carregar tanques:", error);
    }
  }

  parameterSelect.addEventListener('change', updateAll);
  periodSelect.addEventListener('change', updateAll);
  tankSelect.addEventListener('change', updateAll);
  exportBtn.addEventListener('click', () => exportCSV(chartData, parameterSelect.value));

  carregarTanques();

  function carregarConteudo(url) {
  fetch(url)
    .then(response => response.text())
    .then(html => {
      const mainContent = document.getElementById('main-content');
      if (mainContent) {
        mainContent.innerHTML = html;

        if (url.includes('historico_sensor')) {
          initHistoricoSensor();
        }
      }
    })
    .catch(err => console.error('Erro ao carregar conteúdo:', err));
}
document.addEventListener('DOMContentLoaded', () => {
  const links = document.querySelectorAll('.sidebar a');

  links.forEach(link => {
    link.addEventListener('click', e => {
      const url = link.getAttribute('href');

      if (url.includes('logout')) return;

      if (window.location.pathname === '/historico_sensor/') {
        e.preventDefault();
        window.location.href = '/dashboard/'; 
        return;
      }

      e.preventDefault();
      history.pushState(null, '', url);
      carregarConteudo(url);
    });
  });
});

</script>


<style>
  /* ===========================
   CSS Ajustado - Histórico de Sensores
   Substituir o <style> atual por este
   =========================== */

/* Fonte base e reset rápido */
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; padding: 0; }
body {
  font-family: Arial, Helvetica, sans-serif;
  background: #e7e9ec; /* padrão claro similar ao dashboard */
  color: #0f172a;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Container principal */
.dashboard-container {
  display: flex;
  min-height: 100vh;
}

/* SIDEBAR - alinhado com o dashboard */
aside.sidebar {
  width: 220px;
  background-color: #ffffff;
  border-right: 1px solid #e6e6e9;
  padding: 18px 14px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  position: fixed;
  top: 0;
  left: 0;
  height: 100%;
  z-index: 2000;
}

/* título / logo na sidebar */
.sidebar h2 {
  margin: 0 0 8px 0;
  color: #007bff;
  font-size: 1.15rem;
  text-align: center;
}

/* links da sidebar */
.sidebar nav ul { list-style: none; padding: 0; margin: 0; }
.sidebar nav ul li { margin-bottom: 6px; }
.sidebar nav ul li a {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #0b1220;
  text-decoration: none;
  padding: 8px 10px;
  border-radius: 8px;
  transition: background .15s ease, color .15s ease;
  font-size: 0.95rem;
}
.sidebar nav ul li a:hover {
  background: #f1f5f9;
  color: #0b1220;
}

/* main content alinhado ao lado da sidebar */
main.main-content {
  margin-left: 240px; /* sidebar + folga */
  padding: 22px;
  width: calc(100% - 240px);
  min-height: 100vh;
  background: transparent;
}

/* filtros (selects + botão export) */
.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  align-items: end;
  margin-bottom: 20px;
}
.filters > div {
  min-width: 180px;
  flex: 1 1 200px;
}
.filters label {
  display: block;
  font-size: 0.85rem;
  color: #334155;
  margin-bottom: 6px;
  font-weight: 600;
}
.filters select {
  width: 100%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background: #fff;
  color: #0b1220;
  font-size: 0.95rem;
}
#exportBtn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 9px 14px;
  border-radius: 8px;
  border: none;
  background: #2563eb;
  color: white;
  cursor: pointer;
  font-weight: 600;
}

/* cards summary */
.cards-container {
  display: flex;
  gap: 14px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.card-box {
  background: #ffffff;
  border-radius: 10px;
  padding: 14px 16px;
  box-shadow: 0 2px 6px rgba(2,6,23,0.06);
  min-width: 180px;
  flex: 1 1 220px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 6px;
}
.card-box span {
  font-size: 1.45rem;
  font-weight: 700;
}
.card-box h3 {
  margin: 0;
  font-size: 0.95rem;
  color: #475569;
  font-weight: 600;
}

/* cores das métricas */
.green { color: #16a34a; }
.blue  { color: #2563eb; }
.red   { color: #ef4444; }

/* Area do gráfico */
.chart-container {
  background: #ffffff;
  border-radius: 10px;
  padding: 12px;
  box-shadow: 0 2px 8px rgba(2,6,23,0.04);
  margin-bottom: 22px;
}
.chart-container canvas { width: 100% !important; height: auto !important; }

/* tabela de dados */
.table-container {
  background: #ffffff;
  border-radius: 10px;
  padding: 14px;
  box-shadow: 0 2px 8px rgba(2,6,23,0.04);
}
.table-container h2 {
  margin-top: 0;
  margin-bottom: 8px;
  font-size: 1.05rem;
  color: #0f172a;
}
.table-wrapper { overflow-x: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 480px;
}
thead {
  background: #f8fafc;
}
th, td {
  padding: 10px 12px;
  border-bottom: 1px solid #eef2f7;
  text-align: left;
  font-size: 0.95rem;
  color: #0b1220;
}
.status-normal { color: #10b981; font-weight: 700; }
.status-warning { color: #f59e0b; font-weight: 700; }
.status-critical { color: #ef4444; font-weight: 700; }

/* =============================
   Tema escuro (compatível com dashboard.js)
   Adicione/remove a classe `tema-escuro` no body
   ============================= */
body.tema-escuro {
  background: #121212;
  color: #e6eef8;
}
body.tema-escuro aside.sidebar {
  background: #161616;
  border-right-color: #262626;
}
body.tema-escuro .sidebar h2 { color: #cfe8ff; }
body.tema-escuro main.main-content { background: transparent; }
body.tema-escuro .filters { background: transparent; }
body.tema-escuro .filters select {
  background: #0f1724; color: #dbeafe; border: 1px solid #1f2937;
}
body.tema-escuro .card-box, body.tema-escuro .chart-container, body.tema-escuro .table-container {
  background: #0f1724;
  box-shadow: none;
  border: 1px solid #172033;
}
body.tema-escuro thead { background: #0b1220; color: #dbeafe; }
body.tema-escuro th, body.tema-escuro td { color: #dbeafe; border-color: #111827; }

/* =============================
   Mobile / Responsividade
   ============================= */
@media (max-width: 900px) {
  main.main-content { margin-left: 0; padding: 18px; width: 100%; }
  aside.sidebar { position: fixed; z-index: 2000; transform: translateX(0); }
  .dashboard-container { flex-direction: column; }
  .filters > div { flex: 1 1 48%; min-width: 140px; }
  .cards-container { gap: 12px; }
}

@media (max-width: 520px) {
  .filters { gap: 10px; }
  .filters > div { flex-basis: 100%; }
  .card-box { padding: 12px; min-width: 100%; }
  th, td { font-size: 0.9rem; padding: 8px 10px; }
}

</style>