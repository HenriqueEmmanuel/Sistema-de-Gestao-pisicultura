<!-- front/gerenciamento_sensor_content.html -->
{% load static %}
<script src="{% static 'js/gerenciamento_sensor.js' %}" data-dinamico></script>


<div class="cards-container" style="padding: 1rem; border-radius: 8px;">
  <h1 style="font-weight: 700; margin-bottom: 0.1rem;">Gestão de Sensores IoT</h1>
  <p style="margin-top:0; margin-bottom:1rem; color: #555;">Monitore e gerencie sensores ESP32</p>

  <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
    <div class="card" style="flex: 1; min-width: 150px; border-left: 4px solid #22c55e;">
      <strong style="font-size:1.4rem; color:#22c55e;">{{ sensores_ativos }}</strong><br />
      <small>de {{ total_sensores }} sensores</small><br />
      <small>Sensores Ativos</small>
    </div>
    <div class="card" style="flex: 1; min-width: 150px; border-left: 4px solid #3b82f6;">
      <strong style="font-size:1.4rem; color:#3b82f6;">{{ esp32_conectados }}</strong><br />
      <small>de {{ total_esp32 }} dispositivos</small><br />
      <small>ESP32 Conectados</small>
    </div>
    <div class="card" style="flex: 1; min-width: 150px; border-left: 4px solid #f97316;">
      <strong style="font-size:1.4rem; color:#f97316;">{{ alertas }}</strong><br />
      <small>sensors com erro</small><br />
      <small>Alertas</small>
    </div>
    <div class="card" style="flex: 1; min-width: 150px; border-left: 4px solid #8b5cf6;">
      <strong style="font-size:1.4rem; color:#8b5cf6;">{{ ultima_leitura_valor }}</strong><br />
      <small>{{ ultima_leitura_tempo }}</small><br />
      <small>Última Leitura</small>
    </div>
  </div>

  <div style="display: flex; border-bottom: 1px solid #ccc; margin-bottom: 0.8rem;">
    <button class="tab-button active" onclick="mostrarTab('sensores')">Sensores</button>
    <button class="tab-button" onclick="mostrarTab('dispositivos')">Dispositivos ESP32</button>
  </div>

  <section id="sensores" style="display: block;">
    <div style="text-align: right; margin-bottom: 0.8rem;">
      <button onclick="abrirModalAdicionarSensor()"
        style="background-color:#0f172a; color:#fff; padding: 0.5rem 1rem; border-radius: 6px; border:none; cursor:pointer;">
        <i class="fas fa-plus" style="margin-right: 0.3rem;"></i>Adicionar Sensor
      </button>
    </div>

    <table style="width: 100%; border-collapse: collapse;border-radius: 8px; overflow: hidden;">
      <thead style="background-color: #f3f4f6; color: #4b5563; text-align: left;">
        <tr>
          <th style="padding: 0.8rem;">Nome</th>
          <th>Tipo</th>
          <th>Tanque</th>
          <th>Status</th>
          <th>Última Leitura</th>
          <th>ESP32</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for sensor in sensores %}
        <tr style="border-bottom: 1px solid #ddd;">
          <td style="padding: 0.5rem;">
            {% if sensor.tipo == 'temperatura' %}
            <i class="fas fa-thermometer-half" style="margin-right: 0.3rem;"></i>
            {% elif sensor.tipo == 'ph' %}
            <i class="fas fa-tint" style="margin-right: 0.3rem;"></i>
            {% else %}
            <i class="fas fa-microchip" style="margin-right: 0.3rem;"></i>
            {% endif %}
            <strong>{{ sensor.nome }}</strong>
          </td>
          <td>
            <span
              style="background-color:#e0e7ff; color:#3730a3; padding:0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem; text-transform: lowercase;">
              {{ sensor.tipo }}
            </span>
          </td>
          <td>{{ sensor.tanque_nome }}</td>
          <td>
            <span
              style="background-color: #d1fae5; color:#166534; padding: 0.3rem 0.6rem; border-radius: 10px; font-size: 0.85rem;">
              ativo
            </span>
          </td>
          <td>
            <div><strong>{{ sensor.ultima_leitura_valor }}</strong></div>
            <div style="font-size: 0.75rem; color: #6b7280;">{{ sensor.ultima_leitura_hora }}</div>
          </td>
          <td>{{ sensor.esp32_nome }}</td>
          <td>
            <button title="Editar" onclick="editarSensor({{ sensor.id }})"
              style="background:none; border:none; cursor:pointer; margin-right: 0.5rem;">
              <i class="fas fa-edit"></i>
            </button>
            <button title="Excluir" onclick="excluirSensor({{ sensor.id }})"
              style="background:none; border:none; cursor:pointer; color: #b91c1c;">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" style="text-align:center; padding:1rem; color:#6b7280;">Nenhum sensor cadastrado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <section id="dispositivos" style="display: none;">
    <!-- Conteúdo para dispositivos ESP32 (você pode completar conforme necessário) -->
    <p style="color: #555;">Lista de dispositivos ESP32 conectados aparecerá aqui.</p>
  </section>
</div>

<!-- Modal Adicionar Sensor -->
<div id="modalAdicionarSensor"
  style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 1500; justify-content: center; align-items: center;">
  <div class="tabelinha"
    style=" padding: 2rem; border-radius: 10px; max-width: 600px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;">
    <button onclick="fecharModalAdicionarSensor()"
      style="position: absolute; top: 10px; right: 15px; background:none; border:none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
    <h2 style="margin-top: 0;">Adicionar Novo Sensor</h2>

    <form id="formAdicionarSensor" onsubmit="event.preventDefault(); adicionarSensor();">
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <div style="flex: 1 1 280px;">
          <label for="nomeSensor">Nome do Sensor</label><br />
          <input type="text" id="nomeSensor" name="nomeSensor" placeholder="ex: Sensor Temperatura Tanque A" required
            style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
        </div>
        <div style="flex: 1 1 150px;">
          <label for="tipoSensor">Tipo</label><br />
          <select id="tipoSensor" name="tipoSensor" required
            style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">Selecione o tipo</option>
            <option value="temperatura">Temperatura</option>
            <option value="ph">Ph</option>
            <option value="oxigenio">Oxigênio</option>
            <option value="tds">TDS</option>
            <option value="nitrito">Nitrito (NO2-)</option>
            <option value="nitrato">Nitrato (NO3-)</option>
            <option value="oxigenio">Oxigênio Dissolvido</option>
            <option value="amonia">Amônia</option>
          </select>
        </div>
      </div>

      <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <div style="flex: 1 1 200px;">
          <label for="tank">Tanque</label><br />
          <select id="tank" name="tank" required
            style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">Selecione o tanque</option>
          </select>
        </div>
        <div style="flex: 1 1 200px;">
          <label for="esp32Dispositivo">Dispositivo ESP32</label><br />
          <select id="esp32Dispositivo" name="esp32Dispositivo" required
            style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            {% for dispositivo in dispositivos_esp32 %}
            <option value="{{ dispositivo.id }}">{{ dispositivo.nome }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <div style="flex: 1 1 120px;">
          <label for="valorMinimo">Valor Mínimo</label><br />
          <input type="number" step="any" id="valorMinimo" name="valorMinimo"
            style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
        </div>
        <div style="flex: 1 1 120px;">
          <label for="valorMaximo">Valor Máximo</label><br />
          <input type="number" step="any" id="valorMaximo" name="valorMaximo"
            style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
        </div>
        <div style="flex: 1 1 120px;">
          <label for="intervalo">Intervalo (seg)</label><br />
          <input type="number" id="intervalo" name="intervalo" value="300" required
            style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
        </div>
      </div>

      <div style="margin-bottom: 1rem;">
        <label for="unidadeMedida">Unidade de Medida</label><br />
        <input type="text" id="unidadeMedida" name="unidadeMedida" placeholder="ex: °C, pH, mg/L"
          style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
      </div>

      <div style="text-align: right;">
        <button type="button" onclick="fecharModalAdicionarSensor()"
          style="margin-right: 0.6rem; padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #ccc; background: none; cursor: pointer;">Cancelar</button>
        <button type="submit"
          style="background-color: #0f172a; color: white; padding: 0.5rem 1.2rem; border-radius: 6px; border:none; cursor:pointer;">Adicionar
          Sensor</button>
      </div>
    </form>
  </div>
</div>

<script>
  function mostrarTab(tab) {
    document.getElementById('sensores').style.display = (tab === 'sensores') ? 'block' : 'none';
    document.getElementById('dispositivos').style.display = (tab === 'dispositivos') ? 'block' : 'none';

    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    event.currentTarget.classList.add('active');
  }

  function abrirModalAdicionarSensor() {
    document.getElementById('modalAdicionarSensor').style.display = 'flex';
    carregarTanques();
  }

  function fecharModalAdicionarSensor() {
    document.getElementById('modalAdicionarSensor').style.display = 'none';
  }

  function carregarTanques() {
    fetch('/api/tanques-do-usuario/')
      .then(res => res.json())
      .then(tanques => {
        const select = document.getElementById('tank');
        select.innerHTML = '<option value="">Selecione um tanque</option>';
        tanques.forEach(tanque => {
          const option = document.createElement('option');
          option.value = tanque.id;
          option.textContent = tanque.nome;
          select.appendChild(option);
        });
      })
      .catch(err => {
        console.error("Erro ao carregar tanques:", err);
      });
  }

  function adicionarSensor() {
    const form = document.getElementById('formAdicionarSensor');
    const dados = {
      nome: form.nomeSensor.value.trim(),
      tipo: form.tipoSensor.value,
      tanque_id: form.tank.value,
      dispositivo_esp32_id: form.esp32Dispositivo.value,
      valor_minimo: form.valorMinimo.value || null,
      valor_maximo: form.valorMaximo.value || null,
      intervalo: form.intervalo.value,
      unidade_medida: form.unidadeMedida.value.trim(),
    };

    fetch('/api/adicionar-sensor/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
      },
      body: JSON.stringify(dados),
    })
      .then(res => {
        if (!res.ok) throw new Error('Erro ao adicionar sensor');
        return res.json();
      })
      .then(data => {
        if (data.success) {
          fecharModalAdicionarSensor();
          carregarConteudo('/gerenciamento_sensor/');
          Swal.fire('Sucesso!', 'Sensor adicionado com sucesso.', 'success');
        } else {
          Swal.fire('Erro', data.error || 'Erro ao adicionar sensor', 'error');
        }
      })
      .catch(err => {
        console.error(err);
        Swal.fire('Erro', 'Erro ao adicionar sensor', 'error');
      });
  }

  function editarSensor(id) {
    alert('Editar sensor: ' + id);
  }

  function excluirSensor(id) {
    Swal.fire({
      title: 'Tem certeza?',
      text: 'Essa ação irá excluir o sensor.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Sim, excluir',
      cancelButtonText: 'Cancelar'
    }).then(result => {
      if (result.isConfirmed) {
        fetch(`/api/excluir-sensor/${id}/`, {
          method: 'DELETE',
          headers: { 'X-CSRFToken': getCSRFToken() }
        })
          .then(res => {
            if (!res.ok) throw new Error('Erro ao excluir sensor');
            return res.json();
          })
          .then(data => {
            if (data.success) {
              carregarConteudo('/gerenciamento_sensor/');
              Swal.fire('Excluído!', 'Sensor removido com sucesso.', 'success');
            } else {
              Swal.fire('Erro', data.error || 'Erro ao excluir sensor', 'error');
            }
          })
          .catch(err => {
            console.error(err);
            Swal.fire('Erro', 'Erro ao excluir sensor', 'error');
          });
      }
    });
  }

  function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        return decodeURIComponent(cookie.substring(name.length + 1));
      }
    }
    return '';
  }
</script>

<style>
  @media (max-width: 600px) {
    .cards-container {
      padding: 0.5rem;
    }

    table th,
    table td {
      font-size: 0.75rem;
    }

    .tab-button {
      font-size: 0.8rem;
      padding: 0.5rem;
    }
  }

  .tab-button {
    flex: 1;
    background: none;
    border: none;
    padding: 0.7rem 1rem;
    cursor: pointer;
    font-weight: 600;
    color: #6b7280;
    border-bottom: 3px solid transparent;
    transition: color 0.3s, border-bottom-color 0.3s;
  }

  .tab-button.active {
    color: #2563eb;
    border-bottom-color: #2563eb;
    font-weight: 700;
  }
.tabelinha {
  background-color: #fff;
  color: #000;
}

  body.tema-escuro .tabelinha {
  background-color: #1e1e1e;
  color: #eee;
}

body.tema-escuro #modalAdicionarSensor input,
body.tema-escuro #modalAdicionarSensor select {
  background-color: #2c2c2c;
  color: #fff;
  border: 1px solid #555;
}

body.tema-escuro #modalAdicionarSensor button {
  background-color: #374151;
  color: #eee;
  border: 1px solid #555;
}

body.tema-escuro #modalAdicionarSensor button[onclick*="fecharModalAdicionarSensor"] {
  color: #aaa;
}
</style>